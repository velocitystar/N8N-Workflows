{
  "name": "Distortion Check - Simple JSON Source",
  "nodes": [
    {
      "parameters": {},
      "id": "start",
      "name": "Start",
      "type": "n8n-nodes-base.start",
      "typeVersion": 1,
      "position": [-1400, 200]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "voice-victor",
              "name": "victorVoiceId",
              "value": "T9xTMubBGC4Y9y6oHUza",
              "type": "string"
            },
            {
              "id": "voice-lenny",
              "name": "lennyVoiceId",
              "value": "WbI4Toj5UDP91WAiEInp",
              "type": "string"
            },
            {
              "id": "cloudinary-folder",
              "name": "cloudinaryFolder",
              "value": "elevenlabs-audio/episode-01",
              "type": "string"
            },
            {
              "id": "cloudinary-cloud-name",
              "name": "cloudName",
              "value": "dly199qqv",
              "type": "string"
            },
            {
              "id": "rate-limit",
              "name": "maxItems",
              "value": 5,
              "type": "number"
            },
            {
              "id": "start-index",
              "name": "startIndex",
              "value": 0,
              "type": "number"
            },
            {
              "id": "content-url",
              "name": "contentUrl",
              "value": "https://raw.githubusercontent.com/velocitystar/N8N-Workflows/main/docs/distortion-check-ep2.json",
              "type": "string"
            }
          ]
        }
      },
      "id": "set-config",
      "name": "Set Configuration",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [-1200, 200]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{ $json.contentUrl }}",
        "options": {
          "timeout": 10000
        }
      },
      "id": "fetch-content",
      "name": "Fetch JSON Content",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [-1000, 200]
    },
    {
      "parameters": {
        "jsCode": "// Data inspection - return structure as output for debugging\nconst inputData = $input.item;\nconst jsonData = inputData ? inputData.json : null;\n\n// Return debug information as workflow output\nif (!jsonData) {\n  return [{\n    json: {\n      error: 'No JSON data received',\n      inputData: inputData,\n      debugInfo: 'HTTP Request returned no data'\n    }\n  }];\n}\n\n// Check if content exists and is array\nif (jsonData.content && Array.isArray(jsonData.content)) {\n  // Success! Extract the content\n  return [{\n    json: {\n      success: true,\n      scriptLines: jsonData.content,\n      totalScriptLines: jsonData.content.length,\n      debugInfo: `Successfully found content array with ${jsonData.content.length} items`\n    }\n  }];\n}\n\n// Return structure for debugging\nreturn [{\n  json: {\n    error: 'JSON does not have expected content array',\n    jsonDataType: typeof jsonData,\n    jsonDataKeys: Object.keys(jsonData || {}),\n    hasContent: 'content' in (jsonData || {}),\n    contentType: jsonData && jsonData.content ? typeof jsonData.content : 'undefined',\n    contentIsArray: jsonData && jsonData.content ? Array.isArray(jsonData.content) : false,\n    fullStructure: jsonData,\n    debugInfo: 'Check the fullStructure property to see what was actually received'\n  }\n}];"
      },
      "id": "process-content",
      "name": "Process Content",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-800, 200]
    },
    {
      "parameters": {
        "jsCode": "// Debug and create script items\ntry {\n  console.log('ðŸŽ¬ Starting Create Script Items...');\n  \n  const config = $('Set Configuration').item.json;\n  const contentData = $input.item.json;\n  \n  console.log('ðŸ“‹ Config exists:', !!config);\n  console.log('ðŸ“‹ Config keys:', config ? Object.keys(config) : 'none');\n  console.log('ðŸ“‹ ContentData exists:', !!contentData);\n  console.log('ðŸ“‹ ContentData keys:', contentData ? Object.keys(contentData) : 'none');\n  \n  // Check if contentData has scriptLines or if it's the extracted content itself\n  let scriptLines = [];\n  \n  if (contentData.scriptLines) {\n    scriptLines = contentData.scriptLines;\n    console.log('ðŸ“š Found scriptLines property with', scriptLines.length, 'items');\n  } else if (contentData.success && contentData.scriptLines) {\n    scriptLines = contentData.scriptLines; \n    console.log('ðŸ“š Found success with scriptLines:', scriptLines.length, 'items');\n  } else if (Array.isArray(contentData)) {\n    scriptLines = contentData;\n    console.log('ðŸ“š ContentData is array with', scriptLines.length, 'items');\n  } else {\n    console.error('âŒ No scriptLines found in contentData');\n    console.error('ContentData structure:', JSON.stringify(contentData, null, 2));\n    return [{\n      json: {\n        error: 'No scriptLines found',\n        contentDataKeys: Object.keys(contentData || {}),\n        contentDataStructure: contentData\n      }\n    }];\n  }\n  \n  const maxItems = config.maxItems || 5;\n  const startIndex = config.startIndex || 0;\n  \n  console.log('ðŸ“š Total script lines:', scriptLines.length);\n  console.log('ðŸ”¢ Max items per batch:', maxItems);\n  console.log('ðŸŽ¯ Starting from index:', startIndex);\n  \n  // Apply batching\n  const endIndex = Math.min(startIndex + maxItems, scriptLines.length);\n  const selectedLines = scriptLines.slice(startIndex, endIndex);\n  const totalBatches = Math.ceil(scriptLines.length / maxItems);\n  const currentBatch = Math.floor(startIndex / maxItems) + 1;\n  \n  console.log(`ðŸ“Š Processing batch ${currentBatch}/${totalBatches}: lines ${startIndex + 1} to ${endIndex}`);\n  console.log('ðŸ“¦ Selected lines:', selectedLines.length);\n  \n  if (selectedLines.length === 0) {\n    console.warn('âš ï¸ No lines selected! All processing complete.');\n    return [];\n  }\n  \n  // Create individual items for processing\n  const items = selectedLines.map((line, index) => ({\n    json: {\n      ...line,\n      voiceId: line.speaker === 'Victor' ? config.victorVoiceId : config.lennyVoiceId,\n      cloudinaryFolder: config.cloudinaryFolder,\n      cloudName: config.cloudName,\n      itemIndex: index + 1,\n      totalItems: selectedLines.length,\n      batchStartIndex: startIndex,\n      globalIndex: startIndex + index + 1,\n      totalScriptLines: scriptLines.length,\n      currentBatch: currentBatch,\n      totalBatches: totalBatches,\n      publicId: `${config.cloudinaryFolder}/${line.fileName.replace('.wav', '')}`,\n      // Loop control data\n      nextStartIndex: endIndex,\n      hasMoreBatches: endIndex < scriptLines.length,\n      originalConfig: {\n        victorVoiceId: config.victorVoiceId,\n        lennyVoiceId: config.lennyVoiceId,\n        cloudinaryFolder: config.cloudinaryFolder,\n        cloudName: config.cloudName,\n        maxItems: config.maxItems,\n        contentUrl: config.contentUrl,\n        scriptLines: scriptLines\n      }\n    }\n  }));\n  \n  console.log('ðŸ“¦ Created', items.length, 'items for processing');\n  return items;\n  \n} catch (error) {\n  console.error('âŒ Error in Create Script Items:', error.message);\n  return [{\n    json: {\n      error: error.message,\n      debugInfo: 'Check console logs for details'\n    }\n  }];\n}"
      },
      "id": "create-items",
      "name": "Create Script Items",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-600, 200]
    },
    {
      "parameters": {
        "amount": 2
      },
      "id": "wait-2-seconds",
      "name": "Wait 2 Seconds",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [-400, 200]
    },
    {
      "parameters": {
        "jsCode": "const current = $input.item.json;\nconsole.log(`ðŸŽ¤ Processing ${current.globalIndex}/${current.totalScriptLines}: ${current.fileName} (${current.speaker})`);\nconsole.log(`ðŸ“¦ Batch progress: ${current.itemIndex}/${current.totalItems}`);\nconsole.log(`ðŸ” DEBUG: Text content:`, current.text ? `\"${current.text.substring(0, 50)}...\"` : 'NULL/UNDEFINED');\nconsole.log(`ðŸ” DEBUG: VoiceId:`, current.voiceId);\nconsole.log(`ðŸ” DEBUG: All keys:`, Object.keys(current));\nreturn $input.all();"
      },
      "id": "log-progress",
      "name": "Log Progress",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-200, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.elevenlabs.io/v1/text-to-speech/{{ $json.voiceId }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n  \"text\": \"{{ $json.text }}\",\n  \"model_id\": \"eleven_turbo_v2_5\",\n  \"voice_settings\": {\n    \"stability\": 0.5,\n    \"similarity_boost\": 0.5,\n    \"style\": 0.0,\n    \"use_speaker_boost\": true\n  }\n}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          },
          "timeout": 30000
        }
      },
      "id": "generate-audio",
      "name": "Generate Audio",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [0, 200],
      "retryOnFail": true,
      "maxTries": 3,
      "waitBetweenTries": 2000,
      "credentials": {
        "httpHeaderAuth": {
          "id": "elevenlabs-auth",
          "name": "ElevenLabs API"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "check-success",
              "leftValue": "={{ $json.data }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEquals",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        }
      },
      "id": "check-audio",
      "name": "Check Audio Generation",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [200, 200],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const current = $input.item.json;\nconsole.log(`ðŸ”Š Audio generated successfully for: ${current.fileName}`);\nreturn $input.all();"
      },
      "id": "prepare-upload",
      "name": "Prepare for Upload",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [400, 100]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.cloudinary.com/v1_1/{{ $json.cloudName }}/auto/upload",
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "parameterType": "formBinaryData",
              "name": "file",
              "inputDataFieldName": "data"
            },
            {
              "name": "public_id",
              "value": "={{ $json.publicId }}"
            },
            {
              "name": "resource_type",
              "value": "auto"
            },
            {
              "name": "overwrite",
              "value": "true"
            }
          ]
        },
        "options": {
          "timeout": 30000
        }
      },
      "id": "upload-cloudinary",
      "name": "Upload to Cloudinary",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [600, 100],
      "credentials": {
        "httpHeaderAuth": {
          "id": "cloudinary-auth",
          "name": "Cloudinary API"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "check-upload-success",
              "leftValue": "={{ $json.secure_url }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEquals",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        }
      },
      "id": "check-upload",
      "name": "Check Upload Success",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [800, 100],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const current = $input.item.json;\nconsole.log(`âœ… Successfully uploaded: ${current.public_id}`);\nconsole.log(`ðŸ”— URL: ${current.secure_url}`);\nreturn $input.all();"
      },
      "id": "log-success",
      "name": "Log Success",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1000, 50]
    },
    {
      "parameters": {
        "jsCode": "// Check for more batches\nconst allItems = $input.all();\nconst totalItems = allItems.length;\n\nconsole.log(`ðŸŽ‰ BATCH COMPLETED! Processed ${totalItems} files successfully`);\n\nif (totalItems === 0) {\n  console.error('âŒ ERROR: No items received');\n  return [];\n}\n\nconst firstItem = allItems[0];\nconst nextStartIndex = firstItem.json.nextStartIndex;\nconst hasMoreBatches = firstItem.json.hasMoreBatches;\nconst currentBatch = firstItem.json.currentBatch;\nconst totalBatches = firstItem.json.totalBatches;\nconst originalConfig = firstItem.json.originalConfig;\n\nconsole.log(`ðŸ“Š Completed batch ${currentBatch}/${totalBatches}`);\nconsole.log(`ðŸ“Š HasMoreBatches: ${hasMoreBatches}`);\n\nif (hasMoreBatches) {\n  console.log(`ðŸ”„ Will continue to next batch from index ${nextStartIndex}`);\n} else {\n  console.log('ðŸŽŠ ALL BATCHES COMPLETED!');\n}\n\nreturn [{\n  json: {\n    hasMoreBatches: hasMoreBatches,\n    nextStartIndex: nextStartIndex,\n    currentBatch: currentBatch,\n    totalBatches: totalBatches,\n    originalConfig: originalConfig\n  }\n}];"
      },
      "id": "batch-check",
      "name": "Batch Completion Check",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1200, 50]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "has-more-check",
              "leftValue": "={{ String($json.hasMoreBatches) }}",
              "rightValue": "true",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {
          "looseTypeValidation": true
        }
      },
      "id": "more-batches",
      "name": "More Batches?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1400, 50]
    },
    {
      "parameters": {
        "unit": "seconds",
        "amount": 3
      },
      "id": "wait-3-seconds",
      "name": "Wait 3 Seconds",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [1600, -50]
    },
    {
      "parameters": {
        "jsCode": "// Setup next batch\nconst inputItem = $input.item.json;\nconst config = inputItem.originalConfig;\nconst nextStartIndex = inputItem.nextStartIndex;\n\nconsole.log(`ðŸ”„ Setting up next batch from index ${nextStartIndex}`);\n\nreturn [{\n  json: {\n    ...config,\n    startIndex: nextStartIndex\n  }\n}];"
      },
      "id": "setup-next",
      "name": "Setup Next Batch",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1800, -50]
    },
    {
      "parameters": {
        "jsCode": "console.log('ðŸ All batches completed successfully!');\nreturn $input.all();"
      },
      "id": "final-complete",
      "name": "Final Completion",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1600, 150]
    },
    {
      "parameters": {
        "jsCode": "const current = $input.item.json;\nconsole.error(`âŒ Audio generation failed for: ${current.fileName}`);\nreturn $input.all();"
      },
      "id": "log-audio-error",
      "name": "Log Audio Error",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [400, 300]
    },
    {
      "parameters": {
        "jsCode": "const current = $input.item.json;\nconsole.error(`âŒ Upload failed for: ${current.public_id || current.fileName}`);\nreturn $input.all();"
      },
      "id": "log-upload-error",
      "name": "Log Upload Error",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1000, 250]
    }
  ],
  "pinData": {},
  "connections": {
    "Start": {
      "main": [
        [
          {
            "node": "Set Configuration",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Configuration": {
      "main": [
        [
          {
            "node": "Fetch JSON Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch JSON Content": {
      "main": [
        [
          {
            "node": "Process Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Content": {
      "main": [
        [
          {
            "node": "Create Script Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Script Items": {
      "main": [
        [
          {
            "node": "Wait 2 Seconds",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait 2 Seconds": {
      "main": [
        [
          {
            "node": "Log Progress",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Progress": {
      "main": [
        [
          {
            "node": "Generate Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Audio": {
      "main": [
        [
          {
            "node": "Check Audio Generation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Audio Generation": {
      "main": [
        [
          {
            "node": "Prepare for Upload",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Log Audio Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare for Upload": {
      "main": [
        [
          {
            "node": "Upload to Cloudinary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload to Cloudinary": {
      "main": [
        [
          {
            "node": "Check Upload Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Upload Success": {
      "main": [
        [
          {
            "node": "Log Success",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Log Upload Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Success": {
      "main": [
        [
          {
            "node": "Batch Completion Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Batch Completion Check": {
      "main": [
        [
          {
            "node": "More Batches?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "More Batches?": {
      "main": [
        [
          {
            "node": "Wait 3 Seconds",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Final Completion",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait 3 Seconds": {
      "main": [
        [
          {
            "node": "Setup Next Batch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Setup Next Batch": {
      "main": [
        [
          {
            "node": "Create Script Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "workflow-version-id",
  "meta": {
    "instanceId": "n8n-instance"
  },
  "id": "workflow-id",
  "tags": []
}
